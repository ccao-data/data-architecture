models:
  - name: qc.vw_change_in_ahsap_values
    description: '{{ doc("view_vw_change_in_ahsap_values") }}'

  - name: qc.vw_change_in_high_low_value_sales
    description: '{{ doc("view_vw_change_in_high_low_value_sales") }}'
    config:
      tags:
        - data_test_iasworld
        - data_test_iasworld_exclude_from_workbook
    data_tests:
      - expression_is_true:
          name: qc_vw_change_in_high_low_value_sales_ratio_high
          expression: "price_less_than_10k_growth_status = 'No significant change'"
          additional_select_columns:
            - source
            - taxyr
            - price_less_than_10k_growth_status
            - prev_year_price_less_than_10k_count
            - price_less_than_10k_count
          meta:
            table_name: sales
            category: sales_issues
            description: >
              count of sales <= $10k should not change more than 5% YoY
      - expression_is_true:
          name: qc_vw_change_in_high_low_value_sales_ratio_low
          expression: "price_greater_than_1m_growth_status = 'No significant change'"
          additional_select_columns:
            - source
            - taxyr
            - price_greater_than_1m_growth_status
            - prev_year_price_greater_than_1m_count
            - price_greater_than_1m_count
          meta:
            table_name: sales
            category: sales_issues
            description: >
              count of sales >= $1m should not change more than 5% YoY

  - name: qc.vw_iasworld_asmt_all_joined_to_legdat
    description: '{{ doc("view_vw_iasworld_asmt_all_joined_to_legdat") }}'
    config:
      tags:
        - data_test_iasworld
    data_tests:
      - unique_combination_of_columns:
          name: iasworld_asmt_all_unique_by_parid_procname_and_taxyr
          combination_of_columns:
            - parid
            - procname
            - taxyr
          config:
            where: |
              CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
              -- Filter out known dupes in township 74 from one particular day
              -- that were introduced by a bulk data update error
              AND township_code != '74'
              AND procdate NOT BETWEEN '2023-12-19 18:25:28.0' and '2023-12-20 15:07:44.0'
          meta:
            description: asmt_all should be unique by parid, procname, and taxyr

  - name: qc.vw_iasworld_asmt_all_with_prior_year_values
    description: '{{ doc("view_vw_iasworld_asmt_all_with_prior_year_values") }}'

  - name: qc.vw_iasworld_sales_day_of_month
    description: '{{ doc("view_vw_iasworld_sales_day_of_month") }}'
    config:
      tags:
        - data_test_iasworld
        - data_test_iasworld_exclude_from_workbook
    data_tests:
      - expression_is_true:
          name: qc_vw_iasworld_sales_day_of_month_lte_half_observations
          expression: sales_by_day < 0.5 * total_sales
          additional_select_columns:
            - taxyr
            - day_of_month
            - sales_by_day
            - total_sales
          meta:
            table_name: sales
            category: sales_issues
            description: >
              no single day of the month should have > 50% of total sales

  - name: qc.vw_iasworld_sales_high_value_by_class
    description: '{{ doc("view_vw_iasworld_sales_high_value_by_class") }}'
    config:
      tags:
        - data_test_iasworld
    columns:
      - name: price
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_high_value_by_class_gt_20000000
              max_value: 20000000
              additional_select_columns: ["parid", "taxyr", "class", "who" , "wen"]
              meta:
                table_name: sales
                category: sales_issues
                description: price should be <= $20m

  - name: qc.vw_iasworld_sales_latest_sale
    description: '{{ doc("view_vw_iasworld_sales_latest_sale") }}'

  - name: qc.vw_iasworld_sales_null_values
    description: '{{ doc("view_vw_iasworld_sales_null_values") }}'
    config:
      tags:
        - data_test_iasworld
    columns:
      - name: buyer
        data_tests:
          - accepted_range: &sales-null-values
              name: qc_vw_iasworld_sales_null_values_buyer_null_proportion
              max_value: 0.1
              additional_select_columns: ["taxyr"]
              meta:
                table_name: sales
                category: sales_issues
                description: >
                  proportion of sales where buyer is null should not exceed 10%
      - name: deed_type
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_null_values_deed_type_null_proportion
              meta:
                table_name: sales
                category: sales_issues
                description: >
                  proportion of sales where deed_type is null should not exceed 10%
              <<: *sales-null-values
      - name: price
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_null_values_price_null_proportion
              meta:
                table_name: sales
                category: sales_issues
                description: >
                  proportion of sales where price is null should not exceed 10%
              <<: *sales-null-values
      - name: seller
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_null_values_seller_null_proportion
              meta:
                table_name: sales
                category: sales_issues
                description: >
                  proportion of sales where seller is null should not exceed 10%
              <<: *sales-null-values

  - name: qc.vw_iasworld_sales_price_diff_sale_mydec
    description: '{{ doc("view_vw_iasworld_sales_price_diff_sale_mydec") }}'
    config:
      tags:
        - data_test_iasworld
    data_tests:
      # Values of $1000 and below seem to get recoded to $1 in iasWorld
      - expression_is_true:
          name: qc_vw_iasworld_sales_price_diff_sale_mydec_gte_1000
          expression: ABS(price_iasworld - price_mydec) < 999
          additional_select_columns:
            - parid
            - taxyr
            - document_number
            - price_iasworld
            - price_mydec
          meta:
            table_name: sales
            category: sales_issues
            description: >
              price difference between iasworld and mydec should not exceed $1k

  - name: qc.vw_iasworld_sales_rowcount_matches_sale_mydec
    description: '{{ doc("view_vw_iasworld_sales_rowcount_matches_sale_mydec") }}'
    config:
      tags:
        - data_test_iasworld
        - data_test_iasworld_exclude_from_workbook
    columns:
      - name: comparison
        data_tests:
          - accepted_values:
              name: qc_vw_iasworld_sales_rowcount_matches_sale_mydec_check
              values: ['No significant difference']
              additional_select_columns: ["taxyr", "iasworld_sales", "mydec_sales"]
              meta:
                table_name: sales
                category: sales_issues
                description: >
                  the number of sales in iasworld for a given year should be within 5% of mydec

  - name: qc.vw_iasworld_sales_unmatched_joins_sale_mydec
    description: '{{ doc("view_vw_iasworld_sales_unmatched_joins_sale_mydec") }}'
    config:
      tags:
        - data_test_iasworld
        - data_test_iasworld_exclude_from_workbook
    columns:
      - name: iasworld_unmatched
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_unmatched_joins_sale_mydec_iasworld_unmatched_lte_1000
              max_value: 1000
              additional_select_columns: ["taxyr"]
              meta:
                table_name: sales
                category: sales_issues
                description: iasworld should not have >1000 sales that are not in mydec
      - name: mydec_unmatched
        data_tests:
          - accepted_range:
              name: qc_vw_iasworld_sales_unmatched_joins_sale_mydec_mydec_unmatched_lte_1000
              max_value: 1000
              additional_select_columns: ["taxyr"]
              meta:
                table_name: sales
                category: sales_issues
                description: mydec should not have >1000 sales that are not in iasworld

  - name: qc.vw_ic_reference_all_non_res_land_details
    description: '{{ doc("view_vw_ic_reference_all_non_res_land_details") }}'
    config:
      tags:
        - qc_report_ic_reference
    meta:
      export_name: AllNonRes_LandDetails
      export_format:
        columns:
          - name: ACRES
            index: J
            horizontal_align: right
            number_format: "0.####"  # Strip insignificant 0s
          - name: ALLOCPCT
            index: T
            horizontal_align: right
            number_format: "0.####"

  - name: qc.vw_ic_reference_all_non_res_pin_level_data
    description: '{{ doc("view_vw_ic_reference_all_non_res_pin_level_data") }}'
    config:
      tags:
        - qc_report_ic_reference
    meta:
      export_name: AllNonRes_PINLevelData

  - name: qc.vw_ic_reference_all_non_res_pin_level_prior_year_vals
    description: '{{ doc("view_vw_ic_reference_all_non_res_pin_level_prior_year_vals") }}'
    config:
      tags:
        - qc_report_ic_reference
    meta:
      export_name: AllNonRes_PINLevel.PriorYearVals

  - name: qc.vw_ic_reference_all_towns_com_bldg_detail
    description: '{{ doc("view_vw_ic_reference_all_towns_com_bldg_detail") }}'
    config:
      tags:
        - qc_report_ic_reference
    meta:
      export_name: AllTowns_ComBldgDetail
      export_format:
        columns:
          - name: EXMPPCT
            index: BJ
            horizontal_align: right
            number_format: "0.####"  # Strip insignificant 0s
          - name: EXTERNAL OCCPCT
            index: U
            horizontal_align: right
            number_format: "0.####"
          - name: EXTERNAL PROPCT
            index: V
            horizontal_align: right
            number_format: "0.####"
          - name: Occ %
            index: N
            horizontal_align: right
            number_format: "0.####"

  - name: qc.vw_ic_reference_all_towns_oby_detail
    description: '{{ doc("view_vw_ic_reference_all_towns_oby_detail") }}'
    config:
      tags:
        - qc_report_ic_reference
    meta:
      export_name: AllTowns_OBYDetails

  - name: qc.vw_neg_asmt_value
    description: '{{ doc("view_vw_neg_asmt_value") }}'
    config:
      tags:
        - data_test_iasworld
    columns:
      - name: val01
        data_tests:
          - accepted_range: &test-non-negative
              name: qc_vw_neg_asmt_value_val01_gte_0
              min_value: 0
              additional_select_columns: &select-columns-neg-asmt-value
                - taxyr
                - parid
                - township_code
                - class
                - who
                - wen
              config:
                where: |
                  CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
              meta:
                table_name: asmt
                description: val01 (FARM LAND) should not be negative
      - name: val02
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val02_gte_0
              meta:
                table_name: asmt
                description: val02 (MKT LAND) should not be negative
              <<: *test-non-negative
      - name: val03
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val03_gte_0
              meta:
                table_name: asmt
                description: val03 (FARM BLDGS) should not be negative
              <<: *test-non-negative
      - name: val04
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val04_gte_0
              meta:
                table_name: asmt
                description: val04 (MKT BLDGS) should not be negative
              <<: *test-non-negative
      - name: val05
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val05_gte_0
              meta:
                table_name: asmt
                description: val05 (TOTAL MARKET) should not be negative
              <<: *test-non-negative
      - name: val06
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val06_gte_0
              meta:
                table_name: asmt
                description: val06 (ASSD MKT PREF LAND) should not be negative
              <<: *test-non-negative
      - name: val07
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val07_gte_0
              meta:
                table_name: asmt
                description: val07 (ASSD FARMLAND) should not be negative
              <<: *test-non-negative
      - name: val08
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val08_gte_0
              meta:
                table_name: asmt
                description: val08 (ASSD LAND) should not be negative
              <<: *test-non-negative
      - name: val09
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val09_gte_0
              meta:
                table_name: asmt
                description: val09 (DUAL VAL LAND) should not be negative
              <<: *test-non-negative
      - name: val10
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val10_gte_0
              meta:
                table_name: asmt
                description: val10 (ASSD FARM BLDGS) should not be negative
              <<: *test-non-negative
      - name: val11
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val11_gte_0
              meta:
                table_name: asmt
                description: val11 (ASSD BLDGS) should not be negative
              <<: *test-non-negative
      - name: val12
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val12_gte_0
              meta:
                table_name: asmt
                description: val12 (DUAL VAL IMPR) should not be negative
              <<: *test-non-negative
      - name: val13
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val13_gte_0
              meta:
                table_name: asmt
                description: val13 (TOTAL ASSESSED) should not be negative
              <<: *test-non-negative
      - name: val14
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val14_gte_0
              meta:
                table_name: asmt
                description: val14 should not be negative
              <<: *test-non-negative
      - name: val15
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val15_gte_0
              meta:
                table_name: asmt
                description: val15 should not be negative
              <<: *test-non-negative
      - name: val16
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val16_gte_0
              meta:
                table_name: asmt
                description: val16 (DEMOLITIONS ASSD) should not be negative
              <<: *test-non-negative
      - name: val17
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val17_gte_0
              meta:
                table_name: asmt
                description: val17 (STATE RPT OMITTED) should not be negative
              <<: *test-non-negative
      - name: val18
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val18_gte_0
              meta:
                table_name: asmt
                description: val18 (LOCAL EQ MKT PREF LD) should not be negative
              <<: *test-non-negative
      - name: val19
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val19_gte_0
              meta:
                table_name: asmt
                description: val19 (LOCAL EQ FACT LAND) should not be negative
              <<: *test-non-negative
      - name: val20
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val20_gte_0
              meta:
                table_name: asmt
                description: val20 (LOCAL EQ FACT BLDG) should not be negative
              <<: *test-non-negative
      - name: val21
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val21_gte_0
              meta:
                table_name: asmt
                description: val21 (LOCALIZED ASSD L & B) should not be negative
              <<: *test-non-negative
      - name: val22
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val22_gte_0
              meta:
                table_name: asmt
                description: val22 (BOR DUAL VAL LAND) should not be negative
              <<: *test-non-negative
      - name: val23
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val23_gte_0
              meta:
                table_name: asmt
                description: val23 (BOR ASSD FARMLAND) should not be negative
              <<: *test-non-negative
      - name: val24
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val24_gte_0
              meta:
                table_name: asmt
                description: val24 (BOR ASSD LAND) should not be negative
              <<: *test-non-negative
      - name: val25
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val25_gte_0
              meta:
                table_name: asmt
                description: val25 (BOR ASSD FARM BLDGS) should not be negative
              <<: *test-non-negative
      - name: val26
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val26_gte_0
              meta:
                table_name: asmt
                description: val26 (BOR ASSESSED BLDGS) should not be negative
              <<: *test-non-negative
      - name: val27
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val27_gte_0
              meta:
                table_name: asmt
                description: val27 (BOR ASSESED TOTAL) should not be negative
              <<: *test-non-negative
      - name: val28
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val28_gte_0
              meta:
                table_name: asmt
                description: val28 (BOR TOT EXC AG) should not be negative
              <<: *test-non-negative
      - name: val29
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val29_gte_0
              meta:
                table_name: asmt
                description: val29 (ASSD TOT EXC AG) should not be negative
              <<: *test-non-negative
      - name: val30
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val30_gte_0
              meta:
                table_name: asmt
                description: val30 (HIE) should not be negative
              <<: *test-non-negative
      - name: val31
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val31_gte_0
              meta:
                table_name: asmt
                description: val31 (DVHE) should not be negative
              <<: *test-non-negative
      - name: val32
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val32_gte_0
              meta:
                table_name: asmt
                description: val32 (ASSD TOT -(HIE-DVHE)) should not be negative
              <<: *test-non-negative
      - name: val33
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val33_gte_0
              meta:
                table_name: asmt
                description: val33 (STATE EQ ASSD VALUE) should not be negative
              <<: *test-non-negative
      - name: val34
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val34_gte_0
              meta:
                table_name: asmt
                description: val34 (BOR FACT MKT PREF LD) should not be negative
              <<: *test-non-negative
      - name: val35
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val35_gte_0
              meta:
                table_name: asmt
                description: val35 (ASSD FARMLAND) should not be negative
              <<: *test-non-negative
      - name: val36
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val36_gte_0
              meta:
                table_name: asmt
                description: val36 (.ASSD FARM BUILDING) should not be negative
              <<: *test-non-negative
      - name: val37
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val37_gte_0
              meta:
                table_name: asmt
                description: val37 (STATE ASSD POLL CONT) should not be negative
              <<: *test-non-negative
      - name: val38
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val38_gte_0
              meta:
                table_name: asmt
                description: val38 (STATE ASSD RAILROADS) should not be negative
              <<: *test-non-negative
      - name: val39
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val39_gte_0
              meta:
                table_name: asmt
                description: val39 (BOR FACT LAND) should not be negative
              <<: *test-non-negative
      - name: val40
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val40_gte_0
              meta:
                table_name: asmt
                description: val40 (TOTAL ASSESSED VALUE) should not be negative
              <<: *test-non-negative
      - name: val41
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val41_gte_0
              meta:
                table_name: asmt
                description: val41 (BOR FACT BLDG) should not be negative
              <<: *test-non-negative
      - name: val42
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val42_gte_0
              meta:
                table_name: asmt
                description: val42 (40. .:) should not be negative
              <<: *test-non-negative
      - name: val43
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val43_gte_0
              meta:
                table_name: asmt
                description: val43 (HOMESTEADS) should not be negative
              <<: *test-non-negative
      - name: val44
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val44_gte_0
              meta:
                table_name: asmt
                description: val44 (SCAFHE) should not be negative
              <<: *test-non-negative
      - name: val45
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val45_gte_0
              meta:
                table_name: asmt
                description: val45 (DVSHE) should not be negative
              <<: *test-non-negative
      - name: val46
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val46_gte_0
              meta:
                table_name: asmt
                description: val46 (44. .:) should not be negative
              <<: *test-non-negative
      - name: val47
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val47_gte_0
              meta:
                table_name: asmt
                description: val47 (45. .:) should not be negative
              <<: *test-non-negative
      - name: val48
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val48_gte_0
              meta:
                table_name: asmt
                description: val48 (46. .:) should not be negative
              <<: *test-non-negative
      - name: val49
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val49_gte_0
              meta:
                table_name: asmt
                description: val49 (EXPIRED HIE) should not be negative
              <<: *test-non-negative
      - name: val50
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val50_gte_0
              meta:
                table_name: asmt
                description: val50 (TAXABLE EAV) should not be negative
              <<: *test-non-negative
      - name: val51
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val51_gte_0
              meta:
                table_name: asmt
                description: val51 (EXPIRED INCENTIVES) should not be negative
              <<: *test-non-negative
      - name: val52
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val52_gte_0
              meta:
                table_name: asmt
                description: val52 (50. .:) should not be negative
              <<: *test-non-negative
      - name: val53
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val53_gte_0
              meta:
                table_name: asmt
                description: val53 (51. .:) should not be negative
              <<: *test-non-negative
      - name: val54
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val54_gte_0
              meta:
                table_name: asmt
                description: val54 (52. .:) should not be negative
              <<: *test-non-negative
      - name: val55
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val55_gte_0
              meta:
                table_name: asmt
                description: val55 (53. .:) should not be negative
              <<: *test-non-negative
      - name: val56
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val56_gte_0
              meta:
                table_name: asmt
                description: val56 should not be negative
              <<: *test-non-negative
      - name: val57
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val57_gte_0
              meta:
                table_name: asmt
                description: val57 (OMIT TAXABLE EAV) should not be negative
              <<: *test-non-negative
      - name: val58
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val58_gte_0
              meta:
                table_name: asmt
                description: val58 (ROLLBACK TAX EAV) should not be negative
              <<: *test-non-negative
      - name: val59
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val59_gte_0
              meta:
                table_name: asmt
                description: val59 should not be negative
              <<: *test-non-negative
      - name: val60
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_val60_gte_0
              meta:
                table_name: asmt
                description: val60 (NEW PROPERTY) should not be negative
              <<: *test-non-negative
      - name: valapr1
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valapr1_gte_0
              meta:
                table_name: asmt
                description: valapr1 (MKT LAND) should not be negative
              <<: *test-non-negative
          - not_null: &test-val-non-null
              name: qc_vw_neg_asmt_value_valapr1_not_null
              additional_select_columns: *select-columns-neg-asmt-value
              config:
                where: taxyr >= '2023'
              meta:
                table_name: asmt
                description: valapr1 (MKT LAND) should not be null
      - name: valapr2
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valapr2_gte_0
              meta:
                table_name: asmt
                description: valapr2 (MKT BLDG) should not be negative
              <<: *test-non-negative
          - not_null:
              name: qc_vw_neg_asmt_value_valapr2_not_null
              meta:
                table_name: asmt
                description: valapr2 (MKT BLDG) should not be null
              <<: *test-val-non-null
      - name: valapr3
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valapr3_gte_0
              meta:
                table_name: asmt
                description: valapr3 (TOTAL) should not be negative
              <<: *test-non-negative
          - not_null:
              name: qc_vw_neg_asmt_value_valapr3_not_null
              meta:
                table_name: asmt
                description: valapr3 (TOTAL) should not be null
              <<: *test-val-non-null
      - name: valasm1
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valasm1_gte_0
              meta:
                table_name: asmt
                description: valasm1 (ASMT LAND) should not be negative
              <<: *test-non-negative
          - not_null:
              name: qc_vw_neg_asmt_value_valasm1_not_null
              meta:
                table_name: asmt
                description: valasm1 (ASMT LAND) should not be null
              <<: *test-val-non-null
      - name: valasm2
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valasm2_gte_0
              meta:
                table_name: asmt
                description: valasm2 (ASMT BLDG) should not be negative
              <<: *test-non-negative
          - not_null:
              name: qc_vw_neg_asmt_value_valasm2_not_null
              meta:
                table_name: asmt
                description: valasm2 (ASMT BLDG) should not be null
              <<: *test-val-non-null
      - name: valasm3
        data_tests:
          - accepted_range:
              name: qc_vw_neg_asmt_value_valasm3_gte_0
              meta:
                table_name: asmt
                description: valasm3 (ASMT TOTAL) should not be negative
              <<: *test-non-negative
          - not_null:
              name: qc_vw_neg_asmt_value_valasm3_not_null
              meta:
                table_name: asmt
                description: valasm3 (ASMT TOTAL) should not be null
              <<: *test-val-non-null

  - name: qc.vw_nonlivable_condos_with_chars
    description: '{{ doc("view_vw_nonlivable_condos_with_chars") }}'

  - name: qc.vw_pin_appeal_mismatched_outcomes
    description: '{{ doc("view_vw_pin_appeal_mismatched_outcomes") }}'

  - name: qc.vw_pin_sale_high_number_of_sales_per_year
    description: '{{ doc("view_vw_pin_sale_high_number_of_sales_per_year") }}'

  - name: qc.vw_pin_value_null_values
    description: '{{ doc("view_vw_pin_value_null_values") }}'

  - name: qc.vw_report_town_close_0_land_value
    description: '{{ doc("view_vw_report_town_close_0_land_value") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: 0 land value
      export_template: assessed_and_market_values

  - name: qc.vw_report_town_close_0_value
    description: '{{ doc("view_vw_report_town_close_0_value") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: 0 value
      export_template: assessed_and_market_values

  - name: qc.vw_report_town_close_289s
    description: '{{ doc("view_vw_report_town_close_289s") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: 289s

  - name: qc.vw_report_town_close_500k_increase_1m_decrease
    description: '{{ doc("view_vw_report_town_close_500k_increase_1m_decrease") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: 500k increase, 1m decrease
      export_format:
        columns:
          - name: '% Change'
            index: M
            horizontal_align: right

  - name: qc.vw_report_town_close_bldg_parcel_class_mismatch
    description: '{{ doc("view_vw_report_town_close_bldg_parcel_class_mismatch") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Bldg parcel class mismatch

  - name: qc.vw_report_town_close_class_does_not_equal_luc
    description: '{{ doc("view_vw_report_town_close_class_does_not_equal_luc") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Class does not equal LUC

  - name: qc.vw_report_town_close_improved_class_without_bldg_value
    description: '{{ doc("view_vw_report_town_close_improved_class_without_bldg_value") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Improved class, no bldg value
      export_template: assessed_and_market_values

  - name: qc.vw_report_town_close_neg_asmt_value
    description: '{{ doc("view_vw_report_town_close_neg_asmt_value") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Negative ASMT values

  - name: qc.vw_report_town_close_ovrrcnlds_to_review
    description: '{{ doc("view_vw_report_town_close_ovrrcnlds_to_review") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: OVRRCNLD discrepancy checks

  - name: qc.vw_report_town_close_prior_year_card_code_5s_comdat
    description: '{{ doc("view_vw_report_town_close_prior_year_card_code_5s") }}'
    config:
      tags:
        - qc_report_town_close_non_tri
    meta:
      export_name: Card code 5s possibly not at 100% (COMDAT)

  - name: qc.vw_report_town_close_prior_year_card_code_5s_dweldat
    description: '{{ doc("view_vw_report_town_close_prior_year_card_code_5s") }}'
    config:
      tags:
        - qc_report_town_close_non_tri
    meta:
      export_name: Card code 5s possibly not at 100% (DWELDAT)

  - name: qc.vw_report_town_close_prior_year_card_code_5s_oby
    description: '{{ doc("view_vw_report_town_close_prior_year_card_code_5s") }}'
    config:
      tags:
        - qc_report_town_close_non_tri
    meta:
      export_name: Card code 5s possibly not at 100% (OBY)

  - name: qc.vw_report_town_close_res_edit
    description: '{{ doc("view_vw_report_town_close_res_edit") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Res edit
      export_format:
        columns:
          - name: Dwelling % Change
            index: Z
            horizontal_align: right
            number_format: "0.00%"
          - name: Sale Date
            index: AA
            horizontal_align: right
          - name: Total % Change
            index: U
            horizontal_align: right
            number_format: "0.00%"

  - name: qc.vw_report_town_close_res_multicodes
    description: '{{ doc("view_vw_report_town_close_res_multicodes") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Res multicodes
      export_format:
        columns:
          - name: Sale Date
            index: Q
            horizontal_align: right

  - name: qc.vw_report_town_close_res_parcels_not_set_to_cost_approach
    description: '{{ doc("view_vw_report_town_close_res_parcels_not_set_to_cost_approach") }}'
    config:
      tags:
        - qc_report_town_close
        - data_test_iasworld
    meta:
      export_name: Res parcels not set to cost approach
    columns:
      - name: revcode
        data_tests:
          # Equivalent to Res parcels not set to Cost Approach from FP Checklist.
          # The is_null test works here because the view is already filtered for
          # rows where revcode is null or != '1', and since this test is not
          # interested in nulls, checking is_null will effectively return all
          # rows where revcode != '1'
          - is_null:
              name: qc_vw_incorrect_val_method_revcode_eq_1
              additional_select_columns:
                - taxyr
                - parid
                - class
                - township_code
                - who
                - wen
              config:
                where: |
                  CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
              meta:
                table_name: aprval
                description: revcode should be '1' for 200-class parcels
                category: incorrect_values

  - name: qc.vw_report_town_close_vacant_class_with_bldg_value
    description: '{{ doc("view_vw_report_town_close_vacant_class_with_bldg_value") }}'
    config:
      tags:
        - qc_report_town_close
    meta:
      export_name: Vacant class, bldg value
      export_template: assessed_and_market_values

  - name: qc.vw_sale_mydec_null_values
    description: '{{ doc("view_vw_sale_mydec_null_values") }}'
    config:
      tags:
        - data_test_iasworld
        - data_test_iasworld_exclude_from_workbook
    columns:
      - name: address
        data_tests:
          - expression_is_true: &test-not-null
              name: qc_vw_mydec_sales_null_values_address_null_proportion
              expression: '< 0.1'
      - name: buyer
        data_tests:
          - expression_is_true:
              name: qc_vw_mydec_sales_null_values_buyer_null_proportion
              <<: *test-not-null
      - name: deed_type
        data_tests:
          - expression_is_true:
              name: qc_vw_mydec_sales_null_values_deed_type_null_proportion
              <<: *test-not-null
      - name: price
        data_tests:
          - expression_is_true:
              name: qc_vw_mydec_sales_null_values_price_null_proportion
              <<: *test-not-null
      - name: seller
        data_tests:
          - expression_is_true:
              name: qc_vw_mydec_sales_null_values_seller_null_proportion
              <<: *test-not-null
