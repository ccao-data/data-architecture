sources:
  - name: iasworld
    loaded_at_field: date_parse(loaded_at, '%Y-%m-%d %H:%i:%S.%f')
    tags:
      - load_auto
      - data_test_iasworld
      - type_res

    tables:
      - name: dweldat
        description: '{{ doc("table_dweldat") }}'
        freshness:
          filter: taxyr >= date_format(current_date - interval '1' year, '%Y')
          warn_after: {count: 24, period: hour}
          error_after: {count: 48, period: hour}

        columns:
          - name: ac
            description: Air condition
          - name: acarea
            description: Air conditioning area
          - name: accode
            description: Support AC code
          - name: acval
            description: Air conditioning value
          - name: addfact
            description: Additional factor
          - name: addnarea
            description: Living area in additions
          - name: addnrcnval
            description: The RCN from `ADDN`
          - name: addnval
            description: RCN value of additions
          - name: adjarea
            description: Adjusted area
          - name: adjfact
            description: '{{ doc("column_adjfact") }}'
          - name: adjgrmfact
            description: Neighborhood / class factor applied to `RESGRMVAL`
          - name: adjrate
            description: Adjusted base rate
          - name: adjrcnld
            description: Adjusted replacement cost new less depreciation
          - name: areafact
            description: Area factor
          - name: areasum
            description: '{{ doc("column_areasum") }}'
          - name: attic
            description: '{{ doc("shared_column_char_attic_type") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_attic_in_accepted_values
                  values: ['1', '2', '3', '4', '5']
                  additional_select_columns: &select-columns
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                  # Excludes non-regression classes, as defined in Assessor's
                  # online PDF of all class definitions
                  config: &unique-conditions
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                  meta:
                    description: >
                      attic (Attic Type) should be an integer between 1 and 5
              - not_null:
                  name: iasworld_dweldat_attic_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: attic (Attic Type) should not be null
          - name: atticarea
            description: Attic area
          - name: atticval
            description: Attic value
          - name: baserate
            description: Calculated base rate
          - name: basercn
            description: Base replacement cost new
          - name: basercnld
            description: '`RCNLD` for main section of the dwelling'
          - name: bgarval
            description: Basement garage value
          - name: bldguse
            description: Building use
          - name: bld_modelid
            description: '{{ doc("column_bld_modelid") }}'
          - name: bsmt
            description: '{{ doc("shared_column_char_bsmt") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_bsmt_in_accepted_values
                  values: ['1', '2', '3', '4', '5', '6', '7']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      bsmt (Basement Type) should be an integer between 1 and 7
              - not_null:
                  name: iasworld_dweldat_bsmt_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: bsmt (Basement Type) should not be null
          - name: bsmtarea
            description: Unfinished basement area
          - name: bsmtcar
            description: Basement garage (number cars)
          - name: bsmtval
            description: Basement value
          - name: calceffyr
            description: Calculated effective year
          - name: calc_meth
            description: '{{ doc("shared_column_calc_meth") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_calc_meth_accepted_values
                  values: ["E"]
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND calc_meth IS NOT NULL
                  meta:
                    description: >
                      calc_meth (Calculation Method) should be null or 'E'
          - name: card
            description: '{{ doc("column_card") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_card_gte_1
                  min_value: 1
                  additional_select_columns: &select-columns-no-card
                    - parid
                    - taxyr
                    - who
                    - wen
                  config: *unique-conditions
                  meta:
                    description: card should be >= 1
              - not_null:
                  name: iasworld_dweldat_card_not_null
                  additional_select_columns: *select-columns-no-card
                  config: *unique-conditions
                  meta:
                    description: card should not be null
          - name: catharea
            description: Cathedral ceiling area
          - name: cathval
            description: Cathedral ceiling RCN
          - name: cddesc
            description: Cost and Design description code
          - name: cdpct
            description: Cost and Design percent
          - name: cdu
            description: '{{ doc("shared_column_cdu") }}'
          - name: ceiling
            description: Ceilling
          - name: chgrsn
            description: '{{ doc("column_chgrsn") }}'
          - name: class
            description: '{{ doc("shared_column_class") }}'
            data_tests:
              - relationships:
                  name: iasworld_dweldat_class_in_ccao_class_dict
                  to: ref('ccao.class_dict')
                  field: class_code
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND class NOT IN ('EX', 'RR')
                      AND cur = 'Y'
                      AND deactivat IS NULL
                  meta:
                    category: class_mismatch_or_issue
                    description: class code must be valid
              - res_class_matches_pardat:
                  name: iasworld_dweldat_class_matches_pardat_class
                  additional_select_columns: &select-columns-for-pardat-join
                    - column: card
                      agg_func: array_agg
                    - column: taxyr
                      agg_func: max
                    - column: parid
                      agg_func: max
                    - column: who
                      agg_func: max
                    - column: wen
                      agg_func: max
                  config: *unique-conditions
                  meta:
                    description: at least one class should match pardat class
              - res_class_matches_pardat:
                  name: iasworld_dweldat_exempt_classes_match_pardat_class
                  additional_select_columns: *select-columns-for-pardat-join
                  join_type: inner
                  additional_pardat_filter: AND class = 'EX'
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT LIKE 'OA%'
                  meta:
                    description: >
                      at least one class should be exempt or omitted if pardat
                      is exempt
          - name: cline
            description: Condominium line
          - name: cndadjval
            description: Total living area
          - name: cndbaseval
            description: Main section ground floor area
          - name: cndcmplx
            description: Condominium complex
          - name: cnstfact
            description: Construction factor
          - name: cnstval
            description: Construction factor value
          - name: comwallfact
            description: Common wall factor
          - name: comwallpct
            description: Common wall percent
          - name: cond
            description: Condition code
          - name: condolvl
            description: Condominium floor level
          - name: condosflaovr
            description: Condo Sfla override at card level
          - name: condotyp
            description: Condominium type code
          - name: condovw
            description: Condominium View
          - name: convbldg
            description: '{{ doc("column_convbldg") }}'
          - name: cur
            description: '{{ doc("column_cur") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_cur_in_accepted_values
                  values: ['Y', 'D']
                  additional_select_columns: *select-columns
                  config:
                    where: |
                        CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                  meta:
                    description: cur should be 'Y' or 'D'
          - name: deactivat
            description: '{{ doc("column_deactivat") }}'
          - name: degrem
            description: Degree remodeled
          - name: depr
            description: Percent good from tables
          - name: deprt
            description: '{{ doc("column_deprt") }}'
          - name: ecndep
            description: '{{ doc("column_ecndep") }}'
          - name: ecnrsn
            description: '{{ doc("column_ecnrsn") }}'
          - name: effageovr
            description: '{{ doc("column_effageovr") }}'
          - name: eff_area
            description: Support total by card
          - name: effyr
            description: '{{ doc("column_effyr") }}'
          - name: effyrovr
            description: Override effective year
          - name: elepct
            description: Electric percentage
          - name: eleyr
            description: Electric year
          - name: estpct
            description: Estimated percentage
          - name: estyr
            description: Estimated year
          - name: excess
            description: '{{ doc("column_excess") }}'
          - name: exmppct
            description: '{{ doc("column_exmppct") }}'
          - name: exmppctover
            description: Override exemption percent
          - name: exmpval
            description: '{{ doc("column_exmpval") }}'
          - name: external_calc_rcnld
            description: '{{ doc("shared_column_external_calc_rcnld") }}'
            data_tests:
              - not_accepted_values:
                  name: iasworld_dweldat_external_calc_rcnld_not_0
                  values: [0]
                  quote: false
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      external_calc_rcnld (Net Market Value) should not be 0
          - name: external_occpct
            description: '{{ doc("shared_column_external_occpct") }}'
            data_tests:
              - not_accepted_values:
                  name: iasworld_dweldat_external_occpct_not_0
                  values: [0]
                  quote: false
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      external_occpct (Occupancy %) should not be 0
              - not_null:
                  name: iasworld_dweldat_external_occpct_not_null_when_mktrsn_eq_5_or_5b_and_mktadj_is_null
                  additional_select_columns:
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                    - mktrsn
                    - mktadj
                  config:
                    where:
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND mktrsn IN ('5', '5B')
                      AND mktadj IS NULL
                  meta:
                    description: >
                      external_occpct (Occupancy % [current]) should not be null if
                      mktrsn (Reason for Override) is 5 or 5B and
                      mktadj (Occupancy % [deprecated]) is null
          - name: external_propct
            description: '{{ doc("shared_column_external_propct") }}'
            data_tests:
              - not_accepted_values:
                  name: iasworld_dweldat_external_propct_not_0
                  values: [0]
                  quote: false
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      external_propct (Proration %) should not be 0
          - name: external_rcnld
            description: '{{ doc("shared_column_external_rcnld") }}'
            data_tests:
              - not_accepted_values:
                  name: iasworld_dweldat_external_rcnld_not_0
                  values: [0]
                  quote: false
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      external_rcnld (Full Market Value) should not be 0
          - name: extwall
            description: '{{ doc("shared_column_char_ext_wall") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_extwall_in_accepted_values
                  values: ['1', '2', '3', '4', '6', '7', '8', '9']
                  config: *unique-conditions
                  meta:
                    description: >
                      extwall (Exterior Construction) should be 1, 2, 3, 4, 6, 7, 8, or 9
              - not_null:
                  name: iasworld_dweldat_extwall_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: extwall (Exterior Construction) should not be null
          - name: extwall1
            description: Exterior wall code
          - name: extwall1pct
            description: Exterior wall % (for `EXTWALL1`)
          - name: finbsmtarea
            description: Finished basement living area
          - name: finbsmtl
            description: Finished basement living area length
          - name: finbsmtval
            description: Finished basement value
          - name: finbsmtw
            description: Finished basement living area width
          - name: fixaddl
            description: Number additional plumbing fixtures
          - name: fixbath
            description: '{{ doc("shared_column_char_fbath") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_fixbath_matches_number_of_units
                  min_value: 1
                  max_value: |
                    CASE
                      WHEN user14 IS NULL OR user14 = '0' OR user14 = '6' THEN 7
                      WHEN user14 = '1' THEN 14
                      WHEN user14 = '2' THEN 21
                      WHEN user14 = '3' THEN 28
                      WHEN user14 = '4' THEN 35
                      WHEN user14 = '5' THEN 42
                      ELSE 7
                    END
                  additional_select_columns: &select-columns-with-num-units
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                    - user14
                  config: *unique-conditions
                  meta:
                    description: >
                      fixbath (Number of Full Baths) should be <= 7 times the
                      number of units (user14)
              - not_null:
                  name: iasworld_dweldat_fixbath_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      fixbath (Number of Full Baths) should not be null
          - name: fixbath1
            description: Number of full bathrooms on the first floor
          - name: fixbath2
            description: Number of full bathrooms on the second floor
          - name: fixbath3
            description: Number of full bathrooms on the third floor
          - name: fixbath4
            description: Number of four fixture bathrooms
          - name: fixbath4m
            description: Number of four fixture bathrooms  in Main Floor
          - name: fixbath4u
            description: Number of four fixture bathrooms  in upper Floor
          - name: fixbath5
            description: Number of five fixture bathrooms
          - name: fixbath5m
            description: Number of five fixture bathrooms in Main Floor
          - name: fixbath5u
            description: Number of five fixture bathrooms in upper Floor
          - name: fixbath6
            description: Number of six fixture bathrooms
          - name: fixbath7
            description: Number of seven fixture bathrooms
          - name: fixbathb
            description: Number of full bathrooms in the basement
          - name: fixbathm
            description: Number full bathrooms  in Main Floor
          - name: fixbathu
            description: Number full bathrooms  in upper Floor
          - name: fixhalf
            description: '{{ doc("shared_column_char_hbath") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_fixhalf_gte_0
                  min_value: 0
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      fixhalf (Number of Half Baths) should be >= 0
              - accepted_range:
                  name: iasworld_dweldat_fixhalf_matches_number_of_units
                  min_value: 0
                  max_value: |
                    CASE
                      WHEN user14 IS NULL OR user14 = '0' OR user14 = '6' THEN 5
                      WHEN user14 = '1' THEN 10
                      WHEN user14 = '2' THEN 15
                      WHEN user14 = '3' THEN 20
                      WHEN user14 = '4' THEN 25
                      WHEN user14 = '5' THEN 30
                      ELSE 5
                    END
                  additional_select_columns: *select-columns-with-num-units
                  config: *unique-conditions
                  meta:
                    description: >
                      fixhalf (Number of Half Baths) should be <= 5 times the
                      number of units (user14)
          - name: fixhalf1
            description: Number of half baths on the first floor
          - name: fixhalf2
            description: Number of half baths on the second floor
          - name: fixhalf3
            description: Number of half baths on the third floor
          - name: fixhalfb
            description: Number of half baths in the basement
          - name: fixhalfm
            description: Number half bathrooms in Main Floor
          - name: fixhalfu
            description: Number half bathrooms in upper Floor
          - name: fixtot
            description: Total plumbing fixtures
          - name: fixtotovr
            description: Bathroom fixture override
          - name: floor
            description: Floor
          - name: floor1
            description: Floor 1
          - name: floor1pct
            description: Floor percent
          - name: floorfact
            description: Floor factor
          - name: flr1area
            description: Sub total value
          - name: flr1val
            description: First floor structure RCN
          - name: flrharea
            description: Half floor structure square foot
          - name: flrhval
            description: Half floor structure RCN
          - name: flruarea
            description: Upper floor structure square foot
          - name: flruval
            description: Upper floor structure RCN
          - name: fuel
            description: Heating fuel type
          - name: fundep
            description: '{{ doc("column_fundep") }}'
          - name: funrsn
            description: '{{ doc("column_funrsn") }}'
          - name: furpct
            description: Furnace percentage
          - name: furyr
            description: Furnace year
          - name: grade
            description: '{{ doc("shared_column_char_cnst_qlty") }}'
          - name: grdfact
            description: Grade factor
          - name: grmovr
            description: Override for the GRM Multiplier pulled from `LPNBHD`
          - name: grmrent
            description: Gross rent multiplier rent
          - name: grmunits
            description: Gross rent multiplier units
          - name: grpadj
            description: '{{ doc("column_grpadj") }}'
          - name: heat
            description: '{{ doc("shared_column_char_heat") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_heat_in_accepted_values
                  values: ['1', '2', '3', '4']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      heat (Heating) should be an integer between 1 and 4
              - not_null:
                  name: iasworld_dweldat_heat_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      heat (Heating) should not be null
          - name: heatarea
            description: Heat area
          - name: heatsys
            description: Heating system type
          - name: heatval
            description: Heating/air value
          - name: hga
            description: '{{ doc("column_hga") }}'
          - name: iasw_id
            description: '{{ doc("column_iasw_id") }}'
          - name: intext
            description: Interior condition relative to exterior
          - name: intwall
            description: Inside wall
          - name: intwall1
            description: Inside wall 1
          - name: intwall1pct
            description: Inside wall percent
          - name: intwallfact
            description: Inside wall factor
          - name: jur
            description: '{{ doc("column_jur") }}'
          - name: kitpct
            description: Kitchen percentage
          - name: kityr
            description: Kitchen year
          - name: loaded_at
            description: '{{ doc("shared_column_loaded_at") }}'
          - name: locmult
            description: Local multiplier
          - name: lumpcamod
            description: '{{ doc("column_lumpcamod") }}'
          - name: lumpcure
            description: Lump cure value
          - name: mastrimarea
            description: Masonry trim square footage
          - name: mastriml
            description: Masonry trim, length
          - name: mastrimw
            description: Masonry trim, width
          - name: mgfa
            description: Main section ground floor area
          - name: mktadj
            description: '{{ doc("column_mktadj") }}'
            data_tests:
              - not_null:
                  name: iasworld_dweldat_mktadj_not_null_when_mktrsn_eq_5_or_5b_and_external_occpct_is_null
                  additional_select_columns:
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                    - mktrsn
                    - external_occpct
                  config:
                    where:
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND mktrsn IN ('5', '5B')
                      AND external_occpct IS NULL
                  meta:
                    description: >
                      mktadj (Occupancy % [deprecated]) should not be null if
                      mktrsn (Reason for Override) is 5 or 5B and
                      external_occpct (Occupancy % [current]) is null
          - name: mktrsn
            description: '{{ doc("column_chgrsn") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_mktrsn_eq_5_or_5b_when_external_occpct_or_mktadj_not_null
                  values:
                    - '5'
                    - 5B
                  additional_select_columns:
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                    - external_occpct
                    - mktadj
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND (external_occpct IS NOT NULL OR mktadj IS NOT NULL)
                  meta:
                    description: >
                      mktrsn (Reason for Override) should be 5 or 5B
                      if external_occpct (Occupancy % [current]) or
                      mktadj (Occupancy % [deprecated]) is not null
          - name: modover
            description: Residential override model
          - name: mvpattic
            description: MVP Attic
          - name: mvpbsmt
            description: MVP Basement
          - name: mvpsf
            description: MVP square footage
          - name: mvpstyle
            description: MVP style
          - name: mvpunfin
            description: MVP unfinished
          - name: nccalc
            description: '{{ doc("column_nccalc") }}'
          - name: ncoval
            description: '{{ doc("column_ncoval") }}'
          - name: nctot
            description: '{{ doc("column_nctot") }}'
          - name: ncval
            description: '{{ doc("column_ncval") }}'
          - name: newconmo
            description: '{{ doc("column_newconmo") }}'
          - name: newconpct
            description: '{{ doc("column_newconpct") }}'
          - name: numident
            description: Identical units
          - name: obsdep
            description: Observable Condition
          - name: obsrsn
            description: Reason code for observable condition
          - name: ovrmraval
            description: '{{ doc("column_ovrmraval") }}'
          - name: ovrnbhd
            description: '{{ doc("column_ovrnbhd") }}'
          - name: ovrrcn
            description: Override RCN value
          - name: ovrrcnld
            description: '{{ doc("column_ovrrcnld") }}'
          - name: parid
            description: '{{ doc("shared_column_pin") }}'
            data_tests:
              - relationships:
                  name: iasworld_dweldat_parid_in_pardat_parid
                  to: source('iasworld', 'pardat')
                  field: parid
                  additional_select_columns: &select-columns-no-parid
                    - taxyr
                    - card
                    - who
                    - wen
                  config: *unique-conditions
                  meta:
                    category: parid
                    description: parid should be in pardat
              - not_null:
                  name: iasworld_dweldat_parid_not_null
                  additional_select_columns: *select-columns-no-parid
                  config: *unique-conditions
                  meta:
                    description: parid should not be null
          - name: pctcomplete
            description: Percent of construction completed
          - name: plumbgrade
            description: Plumbing grade
          - name: plumval
            description: Plumbing value
          - name: plupct
            description: Plumbing percentage
          - name: pluyr
            description: Plumbing year
          - name: prior_renolvl
            description: Prior renovation Level
          - name: prodamage
            description: '{{ doc("column_prodamage") }}'
          - name: prodate
            description: '{{ doc("column_prodate") }}'
          - name: profact
            description: '{{ doc("column_profact") }}'
          - name: protype
            description: '{{ doc("column_protype") }}'
          - name: rcnfact
            description: RCN adjustment factor
          - name: rcnld
            description: '{{ doc("column_rcnld") }}'
          - name: rcnval
            description: Replacement cost new of dwelling
          - name: recnr
            description: '{{ doc("column_recnr") }}'
          - name: recromarea
            description: Recreational room area
          - name: recroml
            description: Recreational room length
          - name: recromw
            description: Recreational room width
          - name: rectype
            description: '{{ doc("column_rectype") }}'
          - name: recval
            description: Recreational room value
          - name: rembath
            description: Bathrooms remodeled
          - name: remkit
            description: Kitchen remodeled
          - name: renolvl
            description: Renovation level
          - name: renoovr
            description: Override for renovation level
          - name: renopoint
            description: Sum of renovation points assigned to this parcel
          - name: renoyr
            description: Year of renovation
          - name: resfeatval
            description: The total residential feature value
          - name: resgrmval
            description: Gross rent multiplier value
          - name: resmod
            description: Residential cost model
          - name: rmbed
            description: '{{ doc("shared_column_char_beds") }}'
            data_tests:
              - expression_is_true:
                  name: iasworld_dweldat_rmbed_lte_rmtot
                  expression: <= rmtot
                  additional_select_columns:
                    - parid
                    - taxyr
                    - card
                    - who
                    - wen
                    - rmtot
                  config: *unique-conditions
                  meta:
                    category: relationships
                    description: >
                      rmbed (Number of Bedrooms) should be <= rmtot (Number of Rooms)
              - accepted_range:
                  name: iasworld_dweldat_rmbed_matches_number_of_units
                  min_value: 1
                  max_value: |
                    CASE
                      WHEN user14 IS NULL OR user14 = '0' OR user14 = '6' THEN 8
                      WHEN user14 = '1' THEN 16
                      WHEN user14 = '2' THEN 24
                      WHEN user14 = '3' THEN 32
                      WHEN user14 = '4' THEN 40
                      WHEN user14 = '5' THEN 48
                      ELSE 8
                    END
                  additional_select_columns: *select-columns-with-num-units
                  config: *unique-conditions
                  meta:
                    description: >
                      rmbed (Number of Bedrooms) should be <= 8 times the
                      number of units (user14)
              - not_null:
                  name: iasworld_dweldat_rmbed_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      rmbed (Number of Bedrooms) should not be null
          - name: rmbed1
            description: Number of bedrooms on the first floor
          - name: rmbed2
            description: Number of bedrooms on the second floor
          - name: rmbed3
            description: Number of bedrooms on the third floor
          - name: rmbedb
            description: Number of bedrooms in the basement
          - name: rmdin
            description: Total number of dining rooms
          - name: rmdin1
            description: Number of dining rooms on the first floor
          - name: rmdin2
            description: Number of dining rooms on the second floor
          - name: rmdin3
            description: Number of dining rooms on the third floor
          - name: rmdinb
            description: Number of dining rooms in the basement
          - name: rmfam
            description: Number family rooms
          - name: rmfam1
            description: Number of family rooms on the first floor
          - name: rmfam2
            description: Number of family rooms on the second floor
          - name: rmfam3
            description: Number of family rooms on the third floor
          - name: rmfamb
            description: Number of family rooms in the basement
          - name: rmkit
            description: Total number of kitchens
          - name: rmkit1
            description: Number of kitchens on the first floor
          - name: rmkit2
            description: Number of kitchens on the second floor
          - name: rmkit3
            description: Number of kitchens on the third floor
          - name: rmkitb
            description: Number of kitchens in the basement
          - name: rmliv
            description: Total number of living rooms
          - name: rmliv1
            description: Number of living rooms on the first floor
          - name: rmliv2
            description: Number of living rooms on the second floor
          - name: rmliv3
            description: Number of living rooms on the third floor
          - name: rmlivb
            description: Number of living rooms in the basement
          - name: rmoth
            description: Total number of other rooms
          - name: rmoth1
            description: Number of other rooms on the first floor
          - name: rmoth2
            description: Number of other rooms on the second floor
          - name: rmoth3
            description: Number of other rooms on the third floor
          - name: rmothb
            description: Number of other rooms in the basement
          - name: rmtot
            description: '{{ doc("shared_column_char_rooms") }}'
            data_tests:
              - not_null:
                  name: iasworld_dweldat_rmtot_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: rmtot (Number of Rooms) should not be null
              - accepted_range:
                  name: iasworld_dweldat_rmtot_sf_between_1_and_40
                  min_value: 1
                  max_value: 40
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND class NOT IN ('211', '212')
                      AND cur = 'Y'
                      AND deactivat IS NULL
                  meta:
                    description: rmtot (Number of Rooms) should be between 1 and 40
              - accepted_range:
                  name: iasworld_dweldat_rmtot_sf_between_1_and_50
                  min_value: 1
                  max_value: 50
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND class IN ('211', '212')
                      AND cur = 'Y'
                      AND deactivat IS NULL
                  meta:
                    description: rmtot (Number of Rooms) should be between 1 and 50
          - name: salekey
            description: '{{ doc("column_salekey") }}'
          - name: seq
            description: '{{ doc("shared_column_seq") }}'
            data_tests:
              - sequential_values:
                  name: iasworld_dweldat_seq_all_sequential_exist
                  group_by_columns:
                    - parid
                    - taxyr
                    - card
                  additional_select_columns:
                    - who
                    - wen
                  config: *unique-conditions
                  meta:
                    description: seq should be sequential
          - name: sfla
            description: '{{ doc("shared_column_char_bldg_sf") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_999_for_class_202
                  min_value: 1
                  max_value: 999
                  additional_select_columns: &select-columns-with-class
                    - taxyr
                    - parid
                    - card
                    - class
                    - who
                    - wen
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '202'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 999 for class 202 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_2000_for_class_207
                  min_value: 1
                  max_value: 2000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '207'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 2000 for class 207 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_2200_for_class_205
                  min_value: 1
                  max_value: 2200
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '205'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 2200 for class 205 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_10000_for_class_210
                  min_value: 1
                  max_value: 10000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '210'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 10000 for class 210 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_10000_for_class_234
                  min_value: 1
                  max_value: 10000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '234'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 10000 for class 234 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_20000_for_class_212
                  min_value: 1
                  max_value: 20000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '212'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 20000 for class 212 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_20000_for_class_295
                  min_value: 1
                  max_value: 20000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '295'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 20000 for class 295 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1_and_40000_for_class_211
                  min_value: 1
                  max_value: 40000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '211'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1 and 40000 for class 211 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1000_and_1800_for_class_203
                  min_value: 1000
                  max_value: 1800
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '203'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1000 and 1800 for class 203 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_1801_and_25000_for_class_204
                  min_value: 1801
                  max_value: 25000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '204'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      1801 and 25000 for class 204 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_2001_and_3800_for_class_278
                  min_value: 2001
                  max_value: 3800
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '278'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      2001 and 3800 for class 278 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_2201_and_4999_for_class_206
                  min_value: 2201
                  max_value: 4999
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '206'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      2201 and 4999 for class 206 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_3801_and_4999_for_class_208
                  min_value: 3801
                  max_value: 4999
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '208'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      3801 and 4999 for class 208 cards
              - accepted_range:
                  name: iasworld_dweldat_sfla_between_5000_and_50000_for_class_209
                  min_value: 5000
                  max_value: 50000
                  additional_select_columns: *select-columns-with-class
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '209'
                  meta:
                    description: >
                      sfla (Building Square Footage) should be between
                      5000 and 50000 for class 209 cards
              - not_null:
                  name: iasworld_dweldat_sfla_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: sfla (Building Square Footage) should not be null
          - name: shfact
            description: Story height factor
          - name: sidpct
            description: Siding percentage
          - name: sidyr
            description: Siding year
          - name: sizecode
            description: Size code
          - name: slabarea
            description: Slab area
          - name: slabval
            description: Slab value
          - name: stage
            description: Recreation homes level
          - name: status
            description: '{{ doc("column_status") }}'
          - name: stories
            description: '{{ doc("shared_column_char_type_resd") }}'
            data_tests:
              - expression_is_true:
                  name: iasworld_dweldat_stories_in_accepted_values
                  expression: 'IN (1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 9.90)'
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    category: incorrect_values
                    description: >
                      stories (Type of Residence) should be one of 1.00, 2.00,
                      3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, or 9.90
              - not_null:
                  name: iasworld_dweldat_stories_not_null
                  config: *unique-conditions
                  additional_select_columns: *select-columns
                  meta:
                    description: stories (Type of Residence) should not be null
          - name: style
            description: Architectural style
          - name: subtval
            description: Sub total value
          - name: suppress
            description: '{{ doc("column_suppress") }}'
          - name: taxyr
            description: '{{ doc("shared_column_year") }}'
            data_tests:
              - not_null:
                  name: iasworld_dweldat_taxyr_not_null
                  additional_select_columns:
                    - parid
                    - card
                    - who
                    - wen
                  config: *unique-conditions
                  meta:
                    description: taxyr should not be null
          - name: trans_id
            description: '{{ doc("column_trans_id") }}'
          - name: trimval
            description: Masonry trim value
          - name: ufeatarea
            description: Feature area
          - name: ufeatl
            description: Feature length
          - name: ufeatval
            description: Feature value
          - name: ufeatw
            description: Feature width
          - name: unfinarea
            description: Unfinished area
          - name: unfinl
            description: Unfinished area length
          - name: unfinval
            description: Unfinished area value
          - name: unfinw
            description: Unfinished area width
          - name: unitno
            description: '{{ doc("column_unitno") }}'
          - name: upd_status
            description: '{{ doc("column_upd_status") }}'
          - name: user1
            description: '{{ doc("shared_column_char_repair_cnd") }}'
          - name: user2
            description: '{{ doc("shared_column_char_site") }}'
          - name: user3
            description: '{{ doc("shared_column_char_renovation") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_renovation_in_accepted_values
                  values: ['0', '1']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user3 (Renovated) should be '0' or '1'
          - name: user4
            description: '{{ doc("shared_column_char_tp_dsgn") }}'
          - name: user5
            description: '{{ doc("shared_column_char_tp_plan") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_tp_plan_in_accepted_values
                  values: ['0', '1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user5 (Plan of Design) should be '0', '1', or '2'
              - not_null:
                  name: iasworld_dweldat_char_tp_plan_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user5 (Plan of Design) should not be null
          - name: user6
            description: '{{ doc("shared_column_char_attic_fnsh") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_attic_fnsh_in_accepted_values
                  values: ['1', '2', '3']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user6 (Attic Finish) should be '1', '2', or '3'
              - not_null:
                  name: iasworld_dweldat_char_attic_fnsh_not_null
                  additional_select_columns:
                    - parid
                    - taxyr
                    - card
                    - who
                    - wen
                    - attic
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND attic != '3'
                  meta:
                    description: >
                      user6 (Attic Finish) should not be null unless attic is 3 (None)
          - name: user7
            description: '{{ doc("shared_column_char_air") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_air_accepted_values
                  values: ['1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user7 (Central Air Conditioning) should be '1' or '2'
              - not_null:
                  name: iasworld_dweldat_char_air_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user7 (Central Air Conditioning) should not be null
          - name: user12
            description: '{{ doc("shared_column_char_bsmt_fin") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_bsmt_fin_accepted_values
                  values: ['1', '2', '3', '4', '5', '6']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      user12 (Basement Finished) should be an integer between 1 and 6
              - not_null:
                  name: iasworld_dweldat_char_bsmt_fin_not_null
                  additional_select_columns:
                    - parid
                    - taxyr
                    - card
                    - who
                    - wen
                    - bsmt
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND bsmt != '2'
                  meta:
                    description: >
                      user12 (Basement Finished) should not be null unless bsmt is 2 (Slab)
          - name: user13
            description: '{{ doc("shared_column_char_roof_cnst") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_roof_cnst_accepted_values
                  values: ['1', '2', '3', '4', '5', '6']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      user13 (Roof Construction) should be an integer between 1 and 6
              - not_null:
                  name: iasworld_dweldat_char_roof_cnst_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user13 (Roof Construction) should not be null
          - name: user14
            description: '{{ doc("shared_column_char_apts") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_apts_accepted_values
                  values: ['1', '2', '3', '4', '5', '6']
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND class IN ('211', '212')
                      AND cur = 'Y'
                      AND deactivat IS NULL
                  meta:
                    description: >
                      user14 (Total Number of Units) should be an integer
                      between 1 and 6 for class 211 and 212 properties
              - not_null:
                  name: iasworld_dweldat_char_apts_not_null
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND class IN ('211', '212')
                      AND cur = 'Y'
                      AND deactivat IS NULL
                  meta:
                    description: >
                      user14 (Total Number of Units) should not be null
                      for class 211 and 212 properties
          - name: user15
            description: '{{ doc("shared_column_char_use") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_use_accepted_values
                  values: ['1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user15 (Use) should be '1' or '2'
              - not_null:
                  name: iasworld_dweldat_char_use_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user15 (Use) should not be null
          - name: user16
            description: '{{ doc("shared_column_alternative_cdu") }}'
          - name: user17
            description: Age. Deprecated, use `yrblt`
          - name: user20
            description: '{{ doc("shared_column_char_ncu") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_ncu_between_0_and_5
                  values: ['0', '1', '2', '3', '4', '5']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      user20 (No. of Commercial Units) should be an integer between 0 and 5
              - not_accepted_values:
                  name: iasworld_dweldat_char_ncu_not_0_when_class_is_212
                  values:
                    - 0
                  additional_select_columns: *select-columns-with-class
                  config: &unique-conditions-class-212
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '212'
                  meta:
                    description: >
                      user20 (No. of Commercial Units) should not be 0
                      when class is 212
              - not_null:
                  name: iasworld_dweldat_char_ncu_not_null_when_class_is_212
                  additional_select_columns: *select-columns-with-class
                  config: *unique-conditions-class-212
                  meta:
                    description: >
                      user20 (No. of Commercial Units) should not be null
                      when class is 212
              - is_null:
                  name: iasworld_dweldat_char_ncu_null_when_class_is_not_212_and_char_ncu_not_0
                  additional_select_columns: *select-columns-with-class
                  config:
                    # Exclude non-regression classes, exempt/RR parcels, and 212s
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND class NOT IN ('EX', 'RR')
                      AND class != '212'
                      AND user20 != '0'
                  meta:
                    description: >
                      user20 (No. of Commercial Units) should be null or 0
                      when class is not 212
          - name: user24
            description: '{{ doc("shared_column_card_proration_rate") }}'
          - name: user30
            description: '{{ doc("shared_column_char_porch") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_porch_accepted_values
                  values: ['0', '1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user30 (Porch) should be '0', '1', or '2'
          - name: user31
            description: '{{ doc("shared_column_char_gar_att") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_gar_att_accepted_values
                  values: ['1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user31 (Garage Attached) should be '1' or '2'
              - not_null:
                  name: iasworld_dweldat_char_gar_att_not_null
                  additional_select_columns: &select-columns-with-garage-size
                    - taxyr
                    - parid
                    - card
                    - who
                    - wen
                    - user33
                  config: &unique-conditions-with-garage-size
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND user33 != '7'
                  meta:
                    description: >
                      user31 (Garage Attached) should not be null
                      if user33 (Garage Size) is not 7 (NONE)
          - name: user32
            description: '{{ doc("shared_column_char_gar_area") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_gar_area_accepted_values
                  values: ['1', '2']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user32 (Garage in Area) should be '1' or '2'
              - not_null:
                  name: iasworld_dweldat_char_gar_area_not_null
                  additional_select_columns: *select-columns-with-garage-size
                  config: *unique-conditions-with-garage-size
                  meta:
                    description: >
                      user32 (Garage in Area) should not be null
                      if user33 (Garage Size) is not 7 (NONE)
          - name: user33
            description: '{{ doc("shared_column_char_gar_size") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_gar_size_accepted_values
                  values: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      user33 (Garage Size) should be an integer between 1 and 10
              - not_null:
                  name: iasworld_dweldat_char_gar_size_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: user33 (Garage Size) should not be null
          - name: user34
            description: '{{ doc("shared_column_char_gar_cnst") }}'
            data_tests:
              - accepted_values:
                  name: iasworld_dweldat_char_gar_cnst_accepted_values
                  values: ['1', '2', '3', '4']
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      user34 (Garage Construction) should be
                      an integer between 1 and 4
                  tags:
                    # Currently too many failures for this signal to be useful
                    - data_test_iasworld_exclude_from_workbook
              - not_null:
                  name: iasworld_dweldat_char_gar_cnst_not_null
                  additional_select_columns: *select-columns-with-garage-size
                  config: *unique-conditions-with-garage-size
                  meta:
                    description: >
                      user34 (Garage Construction) should not be null
                      if user33 (Garage Size) is not 7 (NONE)
              - is_null:
                  name: iasworld_dweldat_char_gar_cnst_null_if_gar_size_is_null
                  additional_select_columns: *select-columns-with-garage-size
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class NOT IN ('201', '213', '218', '219', '220', '221', '224', '225', '236', '240', '241', '290', '294', '297')
                      AND user33 = '7'
                      AND user34 != '0'
                  meta:
                    description: >
                      user34 (Garage Construction) should be null or 0
                      if user33 (Garage Size) is 7 (NONE)
          - name: useramt
            description: RCN value of additions
          - name: userfact
            description: Living area in additions
          - name: valmeth
            description: Valuation method (MAN/CLT)
          - name: wallhgt
            description: '{{ doc("column_wallhgt") }}'
          - name: wallhgtfact
            description: Wall height factor
          - name: wbfp_o
            description: '{{ doc("shared_column_char_frpl") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_char_frpl_between_0_and_6
                  min_value: 0
                  max_value: 6
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: >
                      wbfp_o (Number of Fireplaces) should be between 0 and 6
          - name: wbfp_pf
            description: Wood burning fireplace - prefab
          - name: wbfp_pfx
            description: Additional stories for prefab fireplace stacks
          - name: wbfp_s
            description: Wood burning fireplace - number of stacks
          - name: wbfpval
            description: Wood burning fireplace value
          - name: wbfp_x
            description: Additional stories for wood-burning fireplace stacks
          - name: wen
            description: '{{ doc("shared_column_updated_at") }}'
          - name: wencalc
            description: '{{ doc("column_wencalc") }}'
          - name: who
            description: '{{ doc("shared_column_updated_by") }}'
          - name: whocalc
            description: '{{ doc("column_whocalc") }}'
          - name: winpct
            description: Windows percentage
          - name: winyr
            description: Windows year
          - name: yrblt
            description: '{{ doc("shared_column_char_yrblt") }}'
            data_tests:
              - accepted_range:
                  name: iasworld_dweldat_yrblt_205_more_than_62_years_old
                  max_value: cast(year(current_date) as integer) - 63
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '205'
                  meta:
                    description: yrblt should be > 62 years old when class is 205
              - accepted_range:
                  name: iasworld_dweldat_yrblt_206_more_than_62_years_old
                  max_value: cast(year(current_date) as integer) - 63
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '206'
                  meta:
                    description: yrblt should be > 62 years old when class is 206
              - accepted_range:
                  name: iasworld_dweldat_yrblt_207_less_than_62_years_old
                  min_value: cast(year(current_date) as integer) - 62
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '207'
                  meta:
                    description: yrblt should be <= 62 years old when class is 207
              - accepted_range:
                  name: iasworld_dweldat_yrblt_208_less_than_62_years_old
                  min_value: cast(year(current_date) as integer) - 62
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '208'
                  meta:
                    description: yrblt should be <= 62 years old when class is 208
              - accepted_range:
                  name: iasworld_dweldat_yrblt_210_more_than_62_years_old
                  max_value: cast(year(current_date) as integer) - 63
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '210'
                  meta:
                    description: yrblt should be > 62 years old when class is 210
              - accepted_range:
                  name: iasworld_dweldat_yrblt_278_less_than_62_years_old
                  min_value: cast(year(current_date) as integer) - 62
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '278'
                  meta:
                    description: yrblt should be <= 62 years old when class is 278
              - accepted_range:
                  name: iasworld_dweldat_yrblt_295_less_than_62_years_old
                  min_value: cast(year(current_date) as integer) - 62
                  additional_select_columns: *select-columns
                  config:
                    where: |
                      CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                      AND cur = 'Y'
                      AND deactivat IS NULL
                      AND class = '295'
                  meta:
                    description: yrblt should be <= 62 years old when class is 295
              - accepted_range:
                  name: iasworld_dweldat_yrblt_between_1850_and_now
                  min_value: 1850
                  max_value: cast(year(current_date) as decimal)
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: yrblt should be between 1850 and now
              - not_null:
                  name: iasworld_dweldat_yrblt_not_null
                  additional_select_columns: *select-columns
                  config: *unique-conditions
                  meta:
                    description: yrblt should not be null
          - name: yrremod
            description: Year remodeled

        data_tests:
          - expression_is_true:
              name: iasworld_dweldat_bsmt_and_user12_match_234_class
              expression: bsmt = '3' and user12 = '1'
              additional_select_columns:
                - parid
                - taxyr
                - card
                - who
                - wen
                - class
                - bsmt
                - user12
              config:
                where: |
                  CAST(taxyr AS int) BETWEEN {{ var('data_test_iasworld_year_start') }} AND {{ var('data_test_iasworld_year_end') }}
                  AND cur = 'Y'
                  AND deactivat IS NULL
                  AND class = '234'
              meta:
                category: incorrect_values
                description: >
                  bsmt (Basement Type) must be 3 - PARTIAL and
                  user12 (Basement Finished) must be 1 - FAMILY ROOM when
                  class is 234 (split level)
          - expression_is_true:
              name: iasworld_dweldat_card_proration_rate_between_0_and_100
              expression: 'CAST(user24 AS decimal) BETWEEN 0.00 AND 100.00'
              additional_select_columns:
                - parid
                - taxyr
                - card
                - who
                - wen
                - user24
              config: *unique-conditions
              meta:
                category: incorrect_values
                description: user24 (Proration %) should be between 0 and 100
          - unique_combination_of_columns:
              name: iasworld_dweldat_unique_by_parid_card_taxyr
              combination_of_columns:
                - parid
                - taxyr
                - card
              additional_select_columns:
                - column: who
                  alias: who
                  agg_func: array_agg
                - column: wen
                  alias: wen
                  agg_func: array_agg
              config: *unique-conditions
              meta:
                description: dweldat should be unique by parid, card, and taxyr
