models:
  - name: default.vw_pin_exemption
    description: '{{ doc("view_vw_pin_exemption") }}'

    columns:
      - name: exemption_amount
        description: '{{ doc("shared_column_exemption_amount") }}'
      - name: exemption_code
        description: '{{ doc("shared_column_exemption_code") }}'
      - name: exemption_description
        description: '{{ doc("shared_column_exemption_description") }}'
      - name: pin
        description: '{{ doc("shared_column_pin") }}'
      - name: year
        description: '{{ doc("shared_column_year") }}'

    data_tests:
      - row_count:
          name: default_vw_pin_exemption_matches_iasworld_exdet
          equals: >
            (
              SELECT COUNT()
              FROM {{ source('iasworld', 'exdet') }}
              WHERE cur = 'Y'
                AND deactivat IS NULL
            )
          meta:
            description: vw_pin_exemption row count should equal iasworld exdet row count
      - unique_combination_of_columns:
          name: default_vw_pin_exemption_unique_by_pin_year_exemption_code
          combination_of_columns:
            - pin
            - year
            - exemption_code
          config:
            error_if: ">10"
          meta:
            description: vw_pin_exemption should be unique by pin, year, and exemption_code