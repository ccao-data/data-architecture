models:
  - name: default.vw_pin_tax_roll
    description: '{{ doc("view_vw_pin_tax_roll") }}'

    columns:
      - name: board_eav
        description: Board of Review certified EAV
      - name: board_taxable_av
        description: Board of Review taxable AV
      - name: certified_eav
        description: Assessor certified EAV
      - name: certified_taxable_av
        description: Assessor Certified Taxable AV
      - name: exe_disabled
        description: '{{ doc("shared_column_exe_disabled") }}'
      - name: exe_freeze
        description: '{{ doc("shared_column_exe_freeze") }}'
      - name: exe_homeowner
        description: '{{ doc("shared_column_exe_homeowner") }}'
      - name: exe_longtime_homeowner
        description: '{{ doc("shared_column_exe_longtime_homeowner") }}'
      - name: exe_muni_built
        description: '{{ doc("shared_column_exe_muni_built") }}'
      - name: exe_senior
        description: '{{ doc("shared_column_exe_senior") }}'
      - name: exe_vet_dis_100
        description: '{{ doc("shared_column_exe_vet_dis_100") }}'
      - name: exe_vet_dis_50_69
        description: '{{ doc("shared_column_exe_vet_dis_50_69") }}'
      - name: exe_vet_dis_ge70
        description: '{{ doc("shared_column_exe_vet_dis_ge70") }}'
      - name: exe_vet_dis_lt50
        description: '{{ doc("shared_column_exe_vet_dis_lt50") }}'
      - name: exe_vet_returning
        description: '{{ doc("shared_column_exe_vet_returning") }}'
      - name: exe_wwii
        description: '{{ doc("shared_column_exe_wwii") }}'
      - name: mailed_eav
        description: Mailed EAV
      - name: mailed_taxable_av
        description: Mailed Taxable AV
      - name: pin
        description: '{{ doc("shared_column_pin") }}'
      - name: year
        description: '{{ doc("shared_column_year") }}'

    data_tests:
      - row_count:
          name: default_vw_pin_tax_roll_matches_iasworld_asmt_all
          equals: >
            (
              SELECT COUNT(DISTINCT(parid, taxyr))
              FROM {{ source('iasworld', 'asmt_all') }}
              WHERE rolltype != 'RR'
                AND deactivat IS NULL
                AND procname IN ('CCAOVALUE', 'CCAOFINAL', 'BORVALUE')
                AND valclass IS NULL
                -- Class 999 are test pins
                AND class NOT IN ('999')
            )
          meta:
            description: vw_pin_tax_roll row count should equal iasworld asmt_all row count
      - unique_combination_of_columns:
          name: default_vw_pin_tax_roll_unique_by_pin_year
          combination_of_columns:
            - pin
            - year
          meta:
            description: vw_pin_tax_roll should be unique by pin and year
