{{
    config(
        materialized='table'
    )
}}

WITH run_ids_to_include AS (
    SELECT run_id
    FROM {{ source('model', 'metadata') }}
    -- This will eventually grab all run_ids where
    -- run_type == comps
    WHERE run_id = '2025-02-11-charming-eric'
)

SELECT
    --ac.meta_year as year,
    ac.meta_pin as pin,
    ac.meta_class,
    ac.meta_card_num,
    ac.meta_card_pct_total_fmv,
    ac.meta_complex_id,
    ac.pred_card_initial_fmv,
    ac.pred_card_final_fmv,
    ac.meta_township_code,
    ac.meta_nbhd_code,
    ac.meta_tieback_proration_rate,
    ac.char_yrblt,
    ac.char_air,
    ac.char_apts,
    ac.char_attic_fnsh,
    ac.char_attic_type,
    ac.char_beds,
    ac.char_bldg_sf,
    ac.char_bsmt,
    ac.char_bsmt_fin,
    ac.char_ext_wall,
    ac.char_fbath,
    ac.char_frpl,
    ac.char_gar1_area,
    ac.char_gar1_att,
    ac.char_gar1_cnst,
    ac.char_gar1_size,
    ac.char_hbath,
    ac.char_land_sf,
    ac.char_heat,
    ac.char_ncu,
    ac.char_porch,
    ac.char_roof_cnst,
    ac.char_rooms,
    ac.char_tp_dsgn,
    ac.char_tp_plan,
    ac.char_type_resd,
    ac.char_use,
    ac.loc_cook_municipality_name,
    ac.loc_env_flood_fema_sfha,
    ac.loc_env_flood_fs_factor,
    ac.loc_env_flood_fs_risk_direction,
    ac.loc_env_ohare_noise_contour_no_buffer_bool,
    ac.loc_school_elementary_district_geoid,
    ac.loc_school_secondary_district_geoid,
    ac.loc_school_unified_district_geoid,
    ac.loc_tax_special_service_area_num,
    ac.loc_access_cmap_walk_nta_score,
    ac.loc_access_cmap_walk_total_score,
    ac.loc_misc_subdivision_id,
    ac.loc_misc_unincorporated_area_bool,
    ac.prox_num_pin_in_half_mile,
    ac.prox_num_bus_stop_in_half_mile,
    ac.prox_num_foreclosure_per_1000_pin_past_5_years,
    ac.prox_num_school_in_half_mile,
    ac.prox_num_school_with_rating_in_half_mile,
    ac.prox_avg_school_rating_in_half_mile,
    ac.prox_nearest_bike_trail_dist_ft,
    ac.prox_nearest_cemetery_dist_ft,
    ac.prox_nearest_cta_route_dist_ft,
    ac.prox_nearest_cta_stop_dist_ft,
    ac.prox_nearest_hospital_dist_ft,
    ac.prox_lake_michigan_dist_ft,
    ac.prox_nearest_major_road_dist_ft,
    ac.prox_nearest_metra_route_dist_ft,
    ac.prox_nearest_metra_stop_dist_ft,
    ac.prox_nearest_park_dist_ft,
    ac.prox_nearest_railroad_dist_ft,
    ac.prox_nearest_water_dist_ft,
    ac.acs5_percent_age_children,
    ac.acs5_percent_age_senior,
    ac.acs5_median_age_total,
    ac.acs5_percent_mobility_no_move,
    ac.acs5_percent_mobility_moved_from_other_state,
    ac.acs5_percent_household_family_married,
    ac.acs5_percent_household_nonfamily_alone,
    ac.acs5_percent_education_high_school,
    ac.acs5_percent_education_bachelor,
    ac.acs5_percent_education_graduate,
    ac.acs5_percent_income_below_poverty_level,
    ac.acs5_median_income_household_past_year,
    ac.acs5_median_income_per_capita_past_year,
    ac.acs5_percent_income_household_received_snap_past_year,
    ac.acs5_percent_employment_unemployed,
    ac.acs5_median_household_total_occupied_year_built,
    ac.acs5_median_household_renter_occupied_gross_rent,
    ac.acs5_median_household_owner_occupied_value,
    ac.acs5_percent_household_owner_occupied,
    ac.acs5_percent_household_total_occupied_w_sel_cond,
    ac.acs5_percent_mobility_moved_in_county,
    ac.other_ihs_avg_year_index,
    ac.other_tax_bill_amount_total,
    ac.other_tax_bill_rate,
    ac.other_school_district_elementary_avg_rating,
    ac.other_school_district_secondary_avg_rating,
    ac.time_sale_year,
    ac.time_sale_week,
    ac.time_sale_quarter_of_year,
    ac.time_sale_week_of_year,
    ac.time_sale_during_school_year,
    ac.time_sale_during_holidays,
    ac.ind_land_gte_95_percentile,
    ac.ind_bldg_gte_95_percentile,
    ac.ind_land_bldg_ratio_gte_10,
    ac.ind_pin_is_multicard,
    ac.loc_longitude,
    ac.loc_latitude,
    ac.time_sale_day,
    ac.time_sale_day_of_year,
    ac.meta_mailed_tot,
    ac.meta_1yr_pri_board_tot,
    ac.meta_2yr_pri_board_tot,
    ac.lag_meta_sale_price,
    ac.lag_char_bldg_sf,
    ac.lag_char_land_sf,
    ac.lag_char_rooms,
    ac.lag_char_beds,
    ac.lag_char_fbath,
    ac.lag_char_hbath,
    ac.lag_char_frpl,
    ac.lag_char_yrblt,
    ac.lag_other_tax_bill_amount_total,
    ac.loc_env_airport_noise_dnl,
    ac.meta_modeling_group,
    ac.meta_pin10_5yr_num_sale,
    ac.meta_strata_1_5yr_num_sale,
    ac.meta_strata_2_5yr_num_sale,
    ac.char_building_pins,
    ac.char_building_units,
    ac.char_building_non_units,
    ac.char_bldg_is_mixed_use,
    ac.char_building_sf,
    ac.char_unit_sf,
    ac.char_bedrooms,
    ac.time_sale_month_of_year,
    ac.time_sale_day_of_month,
    ac.time_sale_day_of_week,
    ac.time_sale_post_covid,
    ac.meta_strata_1,
    ac.meta_strata_2,
    ac.meta_pin10,
    ac.char_recent_renovation,
    ac.prox_nearest_golf_course_dist_ft,
    ac.meta_cdu,
    ac.char_half_baths,
    ac.char_full_baths,
    ac.meta_lline_num,
    ac.loc_tax_municipality_name,
    ac.prox_airport_dnl_total,
    ac.prox_nearest_secondary_road_dist_ft,
    ac.ccao_is_corner_lot,
    ac.loc_census_puma_geoid,
    ac.loc_census_tract_geoid,
    ac.char_class,
    ac.meta_sale_count_past_n_years,
    ac.prox_nearest_university_dist_ft,
    ac.ccao_is_active_exe_homeowner,
    ac.ccao_n_years_exe_homeowner,
    ac.prox_nearest_vacant_land_dist_ft,
    ac.meta_strata_price,
    ac.meta_strata_type,
    ac.prox_nearest_new_construction_dist_ft,
    ac.random,
    ac.flag_strata_is_imputed,
    ac.sq_ft_variance,
    ac.age_variance,
    ac.other_affordability_risk_index,
    ac.other_distressed_community_index,
    ac.shp_parcel_centroid_dist_ft_sd,
    ac.shp_parcel_edge_len_ft_sd,
    ac.shp_parcel_interior_angle_sd,
    ac.shp_parcel_mrr_area_ratio,
    ac.shp_parcel_mrr_side_ratio,
    ac.shp_parcel_num_vertices,
    ac.prox_nearest_road_arterial_daily_traffic,
    ac.prox_nearest_road_arterial_dist_ft,
    ac.prox_nearest_road_arterial_lanes,
    ac.prox_nearest_road_arterial_speed_limit,
    ac.prox_nearest_road_arterial_surface_type,
    ac.prox_nearest_road_collector_daily_traffic,
    ac.prox_nearest_road_collector_dist_ft,
    ac.prox_nearest_road_collector_lanes,
    ac.prox_nearest_road_collector_speed_limit,
    ac.prox_nearest_road_collector_surface_type,
    ac.prox_nearest_road_highway_daily_traffic,
    ac.prox_nearest_road_highway_dist_ft,
    ac.prox_nearest_road_highway_lanes,
    ac.prox_nearest_road_highway_speed_limit,
    ac.prox_nearest_road_highway_surface_type,
    ac.prox_nearest_stadium_dist_ft,
    ac.time_sale_roll_mean_town_t0_w1,
    ac.time_sale_roll_mean_town_t0_w2,
    ac.time_sale_roll_mean_town_t0_w3,
    ac.time_sale_roll_mean_town_t1_w1,
    ac.time_sale_roll_mean_town_t1_w2,
    ac.time_sale_roll_mean_town_t1_w3,
    ac.time_sale_roll_mean_town_t2_w1,
    ac.time_sale_roll_mean_town_t2_w2,
    ac.time_sale_roll_mean_town_t2_w3,
    ac.time_sale_roll_mean_nbhd_t0_w1,
    ac.time_sale_roll_mean_nbhd_t0_w2,
    ac.time_sale_roll_mean_nbhd_t0_w3,
    ac.time_sale_roll_mean_nbhd_t1_w1,
    ac.time_sale_roll_mean_nbhd_t1_w2,
    ac.time_sale_roll_mean_nbhd_t1_w3,
    ac.time_sale_roll_mean_nbhd_t2_w1,
    ac.time_sale_roll_mean_nbhd_t2_w2,
    ac.time_sale_roll_mean_nbhd_t2_w3,
    ac.permit_amount,
    ac.permit_binary,
    ac.meta_pin_num_cards,
    ac.floor,
    ac.time_sale_roll_mean_nbhd_sf_t0_w1,
    ac.time_sale_roll_mean_nbhd_sf_t0_w2,
    ac.time_sale_roll_mean_nbhd_sf_t0_w3,
    ac.time_sale_roll_mean_nbhd_sf_t1_w1,
    ac.time_sale_roll_mean_nbhd_sf_t1_w2,
    ac.time_sale_roll_mean_nbhd_sf_t1_w3,
    ac.time_sale_roll_mean_nbhd_sf_t2_w1,
    ac.time_sale_roll_mean_nbhd_sf_t2_w2,
    ac.time_sale_roll_mean_nbhd_sf_t2_w3,
    ac.time_sale_roll_mean_nbhd_condo_t0_w1,
    ac.time_sale_roll_mean_nbhd_condo_t0_w2,
    ac.time_sale_roll_mean_nbhd_condo_t0_w3,
    ac.time_sale_roll_mean_nbhd_condo_t1_w1,
    ac.time_sale_roll_mean_nbhd_condo_t1_w2,
    ac.time_sale_roll_mean_nbhd_condo_t1_w3,
    ac.time_sale_roll_mean_nbhd_condo_t2_w1,
    ac.time_sale_roll_mean_nbhd_condo_t2_w2,
    ac.time_sale_roll_mean_nbhd_condo_t2_w3,
    ac.meta_bldg_roll_mean,
    ac.meta_pin10_bldg_roll_mean,
    ac.meta_pin10_bldg_roll_pct_sold,
    ac.year,
    ac.run_id,
    ac.township_code,

    -- joined field
    ap.pred_pin_final_fmv_round
from model"."assessment_card ac
left join model"."assessment_pin ap
    on ac.meta_pin = ap.meta_pin
    and ac.run_id = ap.run_id
where ac.run_id IN (select run_id from run_ids_to_include);