import pandas as pd
import requests
import pyarrow as pa
import pyarrow.parquet as pq

# URL of the webpage
url = "https://price-index.housingstudies.org"

# Make a request to fetch the webpage content
response = requests.get(url)
content = response.text

# Locate the Excel file link within the fetched HTML content
link_start = content.find('/data/')
link_end = content.find('.xlsx', link_start) + len('.xlsx')
xlsx_link = content[link_start:link_end]

# Form the complete URL for the Excel file
most_recent_ihs_data_url = url + xlsx_link if xlsx_link.startswith('/') else xlsx_link

# Print the URL
print(most_recent_ihs_data_url)

# Download the Excel file
response = requests.get(most_recent_ihs_data_url)
with open('temp.xlsx', 'wb') as f:
    f.write(response.content)

# Load the Excel file using openpyxl
data = pd.read_excel(response.content, engine='openpyxl', sheet_name=1)

data = data.drop(columns="Unnamed: 1")
data = data.drop(columns="Unnamed: 2")
data = data.drop(columns="Unnamed: 3")

data = data.transpose()

data = data.astype(str)

data.reset_index(inplace=True)

data = data.replace({'Unnamed: 0': 'puma', 'YEARQ': 'name'})

data.to_parquet('output.parquet')
